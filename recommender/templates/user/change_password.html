{% extends "base.html" %}
{% block title %}Change Password{% endblock %}
{% block content %}
<div class="row g-4">
  <!-- LEFT: Change Password Form -->
  <div class="col-lg-6">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4">
        <h3 class="mb-3"><i class="fa-solid fa-key"></i> Change Password</h3>

        <form method="post" id="pwdForm" novalidate>
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">Current Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
              <input type="password" name="current_password" id="curPwd" class="form-control" placeholder="••••••••" required>
              <button class="btn btn-outline-secondary" type="button" id="toggleCur" title="Show/Hide">
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">New Password <span class="text-muted small">(min 6 chars)</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-key"></i></span>
              <input type="password" name="new_password" id="newPwd" class="form-control" placeholder="••••••••" required>
              <button class="btn btn-outline-secondary" type="button" id="toggleNew" title="Show/Hide">
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>

            <!-- Strength meter -->
            <div class="progress mt-2" style="height:6px;">
              <div class="progress-bar" id="pwdStrength" role="progressbar" style="width:0%"></div>
            </div>
            <ul class="small list-unstyled mt-2" id="rules">
              <li id="r-len" class="text-muted"><i class="fa-regular fa-circle"></i> At least 6 characters</li>
              <li id="r-mix" class="text-muted"><i class="fa-regular fa-circle"></i> Mix of upper & lower case</li>
              <li id="r-num" class="text-muted"><i class="fa-regular fa-circle"></i> Includes a number</li>
              <li id="r-spc" class="text-muted"><i class="fa-regular fa-circle"></i> Includes a symbol (!@#$…)</li>
            </ul>
          </div>

          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-shield"></i></span>
              <input type="password" name="confirm_password" id="newPwd2" class="form-control" placeholder="••••••••" required>
              <button class="btn btn-outline-secondary" type="button" id="toggleNew2" title="Show/Hide">
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
          </div>

          <button class="btn btn-success d-inline-flex align-items-center gap-2" id="saveBtn">
            <span class="spinner-border spinner-border-sm d-none" id="btnSpinner" role="status" aria-hidden="true"></span>
            <i class="fa-solid fa-rotate"></i> Update Password
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- RIGHT: Tips / Safety -->
  <div class="col-lg-6">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4">
        <h5 class="mb-3"><i class="fa-solid fa-shield-halved"></i> Security Tips</h5>
        <ul class="small text-muted mb-0">
          <li>Use a unique password you don’t use elsewhere.</li>
          <li>Avoid names, birthdays, or common words.</li>
          <li>Don’t reuse your current password.</li>
          <li>Consider a password manager for strong, unique passwords.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Utilities =====
function scorePassword(p) {
  let score = 0; if (!p) return 0;
  const letters = {};
  for (let i=0; i<p.length; i++) { letters[p[i]] = (letters[p[i]]||0)+1; score += 5.0 / letters[p[i]]; }
  const variations = { digits: /\d/.test(p), lower: /[a-z]/.test(p), upper: /[A-Z]/.test(p), nonWords: /\W/.test(p) };
  let v = 0; Object.values(variations).forEach(x => v += x ? 1 : 0);
  score += (v - 1) * 10;
  return Math.min(100, Math.max(0, parseInt(score)));
}

function setRule(elId, ok) {
  const li = document.getElementById(elId);
  if (!li) return;
  li.classList.toggle('text-success', ok);
  li.classList.toggle('text-muted', !ok);
  const icon = li.querySelector('i');
  if (icon) {
    icon.classList.toggle('fa-circle-check', ok);
    icon.classList.toggle('fa-circle', !ok);
  }
}

function updateStrengthUI(p) {
  const bar = document.getElementById('pwdStrength');
  const s = scorePassword(p);
  bar.style.width = s + '%';
  bar.classList.remove('bg-danger','bg-warning','bg-success');
  if (p.length < 6) { bar.classList.add('bg-danger'); }
  else if (s < 60) { bar.classList.add('bg-warning'); }
  else { bar.classList.add('bg-success'); }

  setRule('r-len', p.length >= 6);
  setRule('r-mix', /[a-z]/.test(p) && /[A-Z]/.test(p));
  setRule('r-num', /\d/.test(p));
  setRule('r-spc', /\W/.test(p));
}

// show/hide toggle helper
function bindToggle(btnId, inpId){
  document.getElementById(btnId)?.addEventListener('click', function(){
    const f = document.getElementById(inpId); const i = this.querySelector('i'); if (!f) return;
    f.type = (f.type === 'password') ? 'text' : 'password';
    i.classList.toggle('fa-eye'); i.classList.toggle('fa-eye-slash');
  });
}

// ===== Bindings =====
bindToggle('toggleCur', 'curPwd');
bindToggle('toggleNew', 'newPwd');
bindToggle('toggleNew2', 'newPwd2');

document.getElementById('newPwd')?.addEventListener('input', function(){ updateStrengthUI(this.value || ''); });

// submit validations + spinner
document.getElementById('pwdForm')?.addEventListener('submit', function(e){
  const cur = document.getElementById('curPwd').value || '';
  const p1 = document.getElementById('newPwd').value || '';
  const p2 = document.getElementById('newPwd2').value || '';

  if (p1.length < 6) {
    e.preventDefault();
    Swal.fire({icon:'error', title:'Password too short', text:'Minimum 6 characters required.'});
    return;
  }
  if (p1 !== p2) {
    e.preventDefault();
    Swal.fire({icon:'error', title:'Passwords do not match'});
    return;
  }
  if (cur === p1) {
    e.preventDefault();
    Swal.fire({icon:'info', title:'Use a different password', text:'New password must differ from current.'});
    return;
  }

  const btn = document.getElementById('saveBtn');
  const spn = document.getElementById('btnSpinner');
  btn?.setAttribute('disabled','true');
  spn?.classList.remove('d-none');
});
</script>
{% endblock %}
