{% extends "base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}
<div class="row g-4">
  <!-- LEFT: Edit Form -->
  <div class="col-lg-7">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4">
        <h3 class="mb-3"><i class="fa-solid fa-user-pen"></i> Edit Profile</h3>
        <form method="post" id="profileForm" novalidate>
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-regular fa-user"></i></span>
              <input type="text" name="name" class="form-control" value="{{ full_name }}" placeholder="e.g., Ramesh Kumar">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Phone</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fa-solid fa-phone"></i></span>
              <input type="tel" name="phone" class="form-control" value="{{ profile.phone }}" inputmode="numeric" pattern="[0-9]{6,15}" placeholder="e.g., 9876543210">
            </div>
            <div class="form-text">Digits only, 6–15 characters.</div>
          </div>

          <div class="mb-2 text-muted d-flex align-items-center gap-2">
            <i class="fa-solid fa-envelope"></i>
            <span id="emailText">{{ request.user.email }}</span>
            <button class="btn btn-sm btn-outline-secondary py-0" type="button" id="copyEmail" title="Copy email">
              <i class="fa-regular fa-copy"></i>
            </button>
          </div>

          <button class="btn btn-success d-inline-flex align-items-center gap-2" id="saveBtn">
            <span class="spinner-border spinner-border-sm d-none" id="btnSpinner" role="status" aria-hidden="true"></span>
            <i class="fa-solid fa-save"></i> Save Changes
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- RIGHT: Account Card -->
  <div class="col-lg-5">
    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
      <div class="card-body p-4">
        <div class="d-flex align-items-center gap-3 mb-3">
          <!-- Avatar with initials -->
          <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
               id="avatar"
               data-name="{{ full_name|default:request.user.username }}"
               style="width:64px;height:64px;background:linear-gradient(135deg,#2e7d32,#66bb6a);">
          </div>
          <div>
            <div class="fw-bold">{{ full_name|default:request.user.username }}</div>
            <div class="text-muted small">Member since {{ request.user.date_joined|date:"d M Y" }}</div>
          </div>
        </div>

        <div class="row text-center g-2 mb-3">
          <div class="col-6">
            <div class="border rounded-3 p-3">
              <div class="text-muted small">Predictions</div>
              <div class="h5 mb-0">{{ pred_count|default:"0" }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded-3 p-3">
              <div class="text-muted small">Last Pred.</div>
              <div class="h6 mb-0">
                {% if last_pred %}
                  {{ last_pred.predicted_label|title }}
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="d-grid gap-2">
          <a href="{% url 'user_history' %}" class="btn btn-outline-success">
            <i class="fa-solid fa-clock-rotate-left me-1"></i> View History
          </a>
          <a href="{% url 'change_password' %}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-key me-1"></i> Change Password
          </a>
          <a href="{% url 'logout' %}" class="btn btn-outline-danger">
            <i class="fa-solid fa-right-from-bracket me-1"></i> Logout
          </a>
        </div>

        {% if last_pred %}
          <div class="small text-muted mt-3">
            <i class="fa-regular fa-clock me-1"></i>
            Last prediction on {{ last_pred.created_at|date:"d M Y H:i" }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
// Avatar initials
(function(){
  const el = document.getElementById('avatar');
  if (!el) return;
  const name = (el.getAttribute('data-name') || '').trim();
  const parts = name.split(/\s+/).filter(Boolean);
  let initials = '';
  if (parts.length >= 2) initials = parts[0][0] + parts[1][0];
  else if (parts.length === 1) initials = parts[0][0];
  else initials = ({{ request.user.username|safe }} || 'U')[0];
  el.textContent = initials.toUpperCase();
})();

// Copy email
document.getElementById('copyEmail')?.addEventListener('click', async () => {
  const t = document.getElementById('emailText')?.innerText || '';
  try { await navigator.clipboard.writeText(t);
    Swal.fire({icon:'success', title:'Copied', text:t});
  } catch { Swal.fire({icon:'warning', title:'Copy failed'}); }
});

// Spinner on submit + client phone check
document.getElementById('profileForm')?.addEventListener('submit', function(e){
  const phone = this.querySelector('input[name="phone"]')?.value || '';
  if (phone && !/^[0-9]{6,15}$/.test(phone)) {
    e.preventDefault();
    Swal.fire({icon:'error', title:'Invalid phone', text:'Use 6–15 digits only.'});
    return;
  }
  const btn = document.getElementById('saveBtn');
  const spn = document.getElementById('btnSpinner');
  btn?.setAttribute('disabled','true');
  spn?.classList.remove('d-none');
});
</script>
{% endblock %}
