{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<h3 class="mb-3"><i class="fa-solid fa-gauge"></i> Dashboard</h3>

<div class="row g-3 mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">Users</div>
          <div class="h3 mb-0">{{ total_users }}</div>
        </div>
        <i class="fa-solid fa-users fa-2xl text-success"></i>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm border-0">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <div class="text-muted">Predictions</div>
          <div class="h3 mb-0">{{ total_predictions }}</div>
        </div>
        <i class="fa-solid fa-seedling fa-2xl text-success"></i>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <!-- fixed height so layout stable rahe -->
      <div class="card-body" style="height:320px">
        <h5 class="mb-3"><i class="fa-solid fa-chart-column"></i> Top Crops</h5>
        <canvas id="cropBar"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-body" style="height:320px">
        <h5 class="mb-3"><i class="fa-solid fa-chart-line"></i> Predictions (7 days)</h5>
        <canvas id="dailyLine"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  // server → JS data
  const cropLabels = {{ crop_labels_json|safe }};
  const cropCounts = {{ crop_counts_json|safe }};
  const dayLabels  = {{ day_labels_json|safe }};
  const dayCounts  = {{ day_counts_json|safe }};

  // Helper: destroy existing chart if already created (fixes “infinite charts”)
  function makeOrReplaceChart(canvasId, config) {
    const existing = Chart.getChart(canvasId);  // Chart.js v3/v4 API
    if (existing) existing.destroy();
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    return new Chart(canvas, config);
  }

  // Bar: Top Crops
  makeOrReplaceChart('cropBar', {
    type: 'bar',
    data: {
      labels: cropLabels,
      datasets: [{ label: 'Count', data: cropCounts }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Line: Predictions last 7 days
  makeOrReplaceChart('dailyLine', {
    type: 'line',
    data: {
      labels: dayLabels,
      datasets: [{ label: 'Predictions', data: dayCounts, fill: true, tension: .3 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
</script>
{% endblock %}
